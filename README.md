
# Markinim
Это исходный код Telegram-бота @BetterMarkinimBot. Код немного запутан (изначально не планировался для открытого доступа), поэтому требует очистки, но он работает. Использование памяти и производительность достаточно хороши. Использует SQLite.

# Развертывание
> Инструкции по использованию Docker [находятся здесь](#deploy-with-docker).

Установите необходимые зависимости:

```shell
$ nimble install
```

Затем создайте файл `secret.ini`, который должен выглядеть следующим образом, где `admin` — ваш Telegram user id, а `token` — токен бота, который можно получить у @BotFather.

```ini
[config]
token = "1234:abcdefg"
admin = 123456
logging = 1
```

Вы также можете добавить параметр `keeplast = 1500` в конфигурацию, чтобы избежать перегрузки оперативной памяти, обрабатывая максимум `keeplast` сообщений за сессию (по умолчанию: `1500`).

```shell
$ nim c -o:markinim src/markinim.nim
$ ./markinim
```

## Развертывание (с Docker)
- Скопируйте `.env.sample` в `.env`.
- Измените значения `BOT_TOKEN` и `ADMIN_ID`.
- При необходимости измените `KEEP_LAST` (по умолчанию: `1500`. Подробнее выше).
- Соберите и запустите образ с помощью команды `docker compose up -d --build`.
- Запустите бота с помощью команды `docker compose up -d`.

### Старые инструкции
> ⚠️ **ВНИМАНИЕ**: устарело. Используйте инструкции по docker compose, указанные выше.
- Соберите образ с помощью команды `docker build -t markinim .`.
- Запустите бота с помощью команды:

```shell
docker run -itd -v="${pwd}/data":/code/data:z --env-file=.env --restart=unless-stopped --name=markinimbot markinim
```

## Резервные копии
> ⚠️ **ВНИМАНИЕ**: это экспериментальный скрипт для создания резервных копий. Он недостаточно протестирован. Используйте на свой страх и риск. Я не несу ответственности за потерю данных. Не уверен, что он работает.
- Установите [`syncthing`](https://syncthing.net/), если хотите синхронизировать резервные копии с другим устройством.
- Скопируйте `tools/backup_script.example.sh` в `tools/backup_script.sh` и отредактируйте его, указав правильные значения для `root_dir`, `backup_directory` и `backup_filename`.
- При желании измените значение `TELEGRAM_ID`, чтобы получать уведомления, когда резервное копирование завершено.
- Скопируйте `tools/backup.example.sh` в `tools/backup.sh` и отредактируйте его, если хотите изменить имя контейнера.
- Настройте cron-задачу для запуска `tools/backup.sh` каждые 4 часа (или в любой другой желаемый интервал).
  - Откройте crontab с помощью `crontab -e`.
  - Добавьте строку:

  ```shell
  0 */4 * * * /path/to/markinim/tools/backup.sh
  ```

  - Сохраните и выйдите.
- Готово! Теперь резервная копия будет создаваться каждые 4 часа в указанной директории. По поводу вопросов, пишите в тг - @Sayque
